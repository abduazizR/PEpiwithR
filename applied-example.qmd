---
title: "Applied example SGLT2i vs GLP-1RAs and the risk of bladder cancer"
format: html
editor: visual
author: Abdullah Abdelaziz
---

```{r}
#|label: packages
library(tidyverse)
library(arrow)
library(duckdb)
library(RVerbalExpressions)
library(here)
library(gtsummary)
library(rms)
library(WeightIt)
library(broom)
library(cobalt)
```

```{r}
#|label: datasets
ccaeo <- open_dataset("C:\\truven2\\ccae\\o")
ccaei <- open_dataset("C:\\truven2\\ccae\\i")
ccaed <- open_dataset("C:\\truven2\\ccae\\d")
ccaet <- open_dataset("C:\\truven2\\ccae\\t")
```

# About the study design

This is an active comparator new user design comparing SGLT2is vs GLP1RAs and risk of bladder cancer.

## Codes

### Exposure

The exposures are GLP1RAs and SGLT-2 inhibitors Notes on defining the exposure:\
- I will not consider SGLT-2 combinations with metformin or DPP4. The same will be applied to GLP1RAs

```{r}
redbook <- read_parquet("C:\\truven2\\redbook.parquet")

SGLT2_drugs <-  c("00003142711", "00003142811", "00006536303", "00006536306", "00006536307",
                  "00006536308", "00006536309", "00006536310", "00006536403", "00006536406",
                  "00006536407", "00006536408", "00006536409", "00310620530", "00310621030",
                  "00310621039", "00597015230", "00597015237", "00597015290", "00597015330",
                  "00597015337", "00597015390", "50090348100", "50090348200", "50090436400",
                  "50090438400", "50090449200", "50090502900", "50090503300", "50090503301",
                  "50090503400", "50090503401", "50090618200", "50090618300", "50458014030", 
                  "50458014090", "50458014130", "50458014190", "55154041108", "55154041208",
                  "55154142508", "55154142608", "55154693208", "55154693308")

# Write into parquet for future use
# write_parquet(SGLT2_drugs, here("data/SGLT2_drugs.parquet"))

GLP1RAs_drugs <-
c("00002143301", "00002143361", "00002143380", "00002143401", "00002143461", "00002143480",
"00002223601", "00002223680", "00002318201", "00002318280", "00024574502", "00024574702",
"00169280015", "00169406012", "00169406013", "00169406090", "00169406099", "00169413001",
"00169413013", "00169413211", "00169413212", "00169413602", "00169418113", "00169430313",
"00169430330", "00169430713", "00169430730", "00169431413", "00169431430", "00169450114",
"00169450514", "00169451714", "00169452414", "00169452514", "00169477212", "00169477297",
"00173086601", "00173086602", "00173086635", "00173086701", "00173086735", "00310651201",
"00310652004", "00310652401", "00310653001", "00310653004", "00310654001", "00310654004",
"50090285300", "50090348300", "50090348400", "50090425700", "50090450300", "50090546700",
"50090594900", "50090605100", "54569650700", "54868538400", "54868538401", "66780021007",
"66780021008", "66780021201", "66780021904", "66780022601", "68258894701", "68258894802")
```

### Outcome

The outcome is bladder cancer events defined by ICD10 codes

```{r}
bladder_cancer_regex <- "^(C670|C671|C672|C673|C674|C675|C676|C677|C678|C679|C7911|D090|D414|D494)(.*)"
```

### Covariates

Demographics (To be added later): Age, Sex, Cohort entry Date or Year, and region Comorbidities and medications: coded below

```{r}
#|label: comorbidities in regular expression (regex)
# Hypertension
hypertension_regex <- 
"^(I10|O10011|O10012|O10013|O10019|O1002|O1003|O10911|O10912|O10913|O10919|O1092|O1093|O161|O162|O163|O164|O165|O169|H35031|H35032|H35033|I110|I119|I120|I129|I130|I1310|I1311|I132|I150|I151|I152|I158|I159|I160|I161|I169|I674|I973|O10111|O10112|O10113|O10119|O1012|O1013|O10211|O10212|O10213|O10219|O1022|O1023|O10311|O10312|O10313|O10319|O1032|O1033|O10411|O10412|O10413|O10419|O1042|O1043|O111|O112|O113|O114|O115|O119|O131|O132|O133|O134|O135|O139|I868|I87001|I87002|I87003|I87009|I87011|I87012|I87013|I87019|I87021|I87022|I87023|I87029|I87031|I87032|I87033|I87039|I87091|I87092|I87093|I87099|I871|I872|I87301|I87302|I87303|I87309|I87311|I87312|I87313|I87319|I87321|I87322|I87323|I87329|I87331|I87332|I87333|I87339|I87391|I87392|I87393|I87399|O10011|O10012|O10013|O10019|O1002|O1003|O10111|O10112|O10113|O10119|O1012|O1013|O10211|O10212|O10213|O10219|O1022|O1023|O10311|O10312|O10313|O10319|O1032|O1033|O10411|O10412|O10413|O10419|O1042|O1043|O10911|O10912|O10913|O10919|O1092|O1093|O111|O112|O113|O114|O115|O119|O131|O132|O133|O134|O135|O139|O1400|O1402|O1403|O1404|O1405|O1410|O1412|O1413|O1414|O1415|O1420|O1422|O1423|O1424|O1425|O1490|O1492|O1493|O1494|O1495|O1500|O1502|O1503|O151|O152|O159|O161|O162|O163|O164|O165|O169)(.*)"

# Liver disease
liver_disease_regex <- 
"^(K7040|K7041|K7200|K7201|K7210|K7211|K7290|K7291|K9182|A5274|B670|B675|K700|K702|K7030|K7031|K709|K710|K7110|K7111|K717|K718|K719|K740|K7400|K7401|K7402|K741|K742|K743|K744|K745|K7460|K7469|K751|K7589|K759|K760|K761|K762|K763|K764|K765|K766|K767|K7681|K7682|K7689|K769|K77|O26611|O26612|O26613|O26619|O2662|O2663|K712|K713|K714|K7150|K7151|K716|K730|K731|K732|K738|K739|K752|K753|K754|K7581|A5145|B0081|B150|B159|B160|B161|B162|B169|B170|B1710|B1711|B172|B178|B179|B180|B181|B182|B188|B189|B190|B1910|B1911|B1920|B1921|B199|B251|B2681|B581|K7010|K7011|O98411|O98412|O98413|O98419|O9842|O9843|P353|C220|C222|C223|C224|C227|C228|C229|D015)(.*)"


# Hyperlipidemia
hyperlipidemia_regex <- "^(E780|E7800|E7801|E781|E782|E783|E784|E7841|E7849|E785)(.*)"

# Dialysis or end-stage renal disease (exclusion criteria)
## ESRD diagnosis codes
esrd_regex <- "^(I120|I120|I1311|I1311|I132|I132|I132|N186)(.*)"


## Dialysis procedure codes
### ICD10 procedure codes
dialysis_regex <- 
"^(5A1D00Z|5A1D60Z|5A1D70Z|5A1D80Z|5A1D90Z|90935|90937|90940|G0257|G0491|G0492)(.*)"



# Organ transplant recipient (exclusion criteria)

transplant_regex <- 
"^(02YA0Z0|02YA0Z1|02YA0Z2|0WY20Z0|0WY20Z1|0UY00Z0|0UY00Z1|0UY00Z2|0UY10Z0|0UY10Z1|0UY10Z2|0UY90Z0|0UY90Z1|0UY90Z2|0DY50Z0|0DY50Z1|0DY50Z2|0DY60Z0|0DY60Z1|0DY60Z2|0DY80Z0|0DY80Z1|0DY80Z2|0DYE0Z0|0DYE0Z1|0DYE0Z2|0FY00Z0|0FY00Z1|0FY00Z2|0FYG0Z0|0FYG0Z1|0FYG0Z2|07YM0Z0|07YM0Z1|07YM0Z2|07YP0Z0|07YP0Z1|07YP0Z2|0VY50Z0|0VY50Z1|0VY50Z2|0VYS0Z0|0VYS0Z1|0VYS0Z2|0XYJ0Z0|0XYJ0Z1|0XYK0Z0|0XYK0Z1|0BYC0Z0|0BYC0Z1|0BYC0Z2|0BYD0Z0|0BYD0Z1|0BYD0Z2|0BYF0Z0|0BYF0Z1|0BYF0Z2|0BYG0Z0|0BYG0Z1|0BYG0Z2|0BYH0Z0|0BYH0Z1|0BYH0Z2|0BYJ0Z0|0BYJ0Z1|0BYJ0Z2|0BYK0Z0|0BYK0Z1|0BYK0Z2|0BYL0Z0|0BYL0Z1|0BYL0Z2|0BYM0Z0|0BYM0Z1|0BYM0Z2|0TY00Z0|0TY00Z1|0TY00Z2|0TY10Z0|0TY10Z1|0TY10Z2|65755|65756|65757|38205|38206|38207|38208|38209|38210|38211|38212|38213|38214|38215|38240|38241|38242|38243|32851|32852|32853|32854|32855|32856|33944|33945|44135|44136|44720|44721|47140|47141|47142|47143|47144|47145|47146|47147|48551|48552|65780|65781|65782|65710|65730|65750|S2140|50360|50365|50380|S2065|0494T|0495T|0496T|0584T|0585T|0586T|0668T|0669T|0670T|33930|33933|33935|44715|47135|48160|48554|G0341|G0342|G0343|S2053|S2054|S2055|S2060|S2102|S2103|S2152)(.*)"


# Type 2 diabetes diagnosis (inclusion criteria)
type2_diabetes_regex <- "^(E119|O24111|O24112|O24113|O24119|O2412|O2413|E1100|E1101|E1110|E1111|E1121|E1122|E1129|E11311|E11319|E11321|E113211|E113212|E113213|E113219|E11329|E113291|E113292|E113293|E113299|E11331|E113311|E113312|E113313|E113319|E11339|E113391|E113392|E113393|E113399|E11341|E113411|E113412|E113413|E113419|E11349|E113491|E113492|E113493|E113499|E11351|E113511|E113512|E113513|E113519|E113521|E113522|E113523|E113529|E113531|E113532|E113533|E113539|E113541|E113542|E113543|E113549|E113551|E113552|E113553|E113559|E11359|E113591|E113592|E113593|E113599|E1136|E1137X1|E1137X2|E1137X3|E1137X9|E1139|E1140|E1141|E1142|E1143|E1144|E1149|E1151|E1152|E1159|E11610|E11618|E11620|E11621|E11622|E11628|E11630|E11638|E11641|E11649|E1165|E1169|E118|E1100|E1101|E1110|E1111|E1121|E1122|E1129|E11311|E11319|E11321|E113211|E113212|E113213|E113219|E11329|E113291|E113292|E113293|E113299|E11331|E113311|E113312|E113313|E113319|E11339|E113391|E113392|E113393|E113399|E11341|E113411|E113412|E113413|E113419|E11349|E113491|E113492|E113493|E113499|E11351|E113511|E113512|E113513|E113519|E113521|E113522|E113523|E113529|E113531|E113532|E113533|E113539|E113541|E113542|E113543|E113549|E113551|E113552|E113553|E113559|E11359|E113591|E113592|E113593|E113599|E1136|E1137X1|E1137X2|E1137X3|E1137X9|E1139|E1140|E1141|E1142|E1143|E1144|E1149|E1151|E1152|E1159|E11610|E11618|E11620|E11621|E11622|E11628|E11630|E11638|E11641|E11649|E1165|E1169|E118|E119|O24111|O24112|O24113|O24119|O2412|O2413)(.*)"

```

```{r}
#|label: medications
# Metformin use
metformin_drugs <- redbook |> 
    filter(str_detect(GENNME, "(?i)(metformin)"))

metformin_drugs_regex <- "(00003422111|00003422216|00003422311|00006007814|00006007828|00006007861|00006007862|00006007882|00006008014|00006008028|00006008061|00006008062|00006008082|00006008107|00006008114|00006008131|00006008154|00006008182|00006057501|00006057502|00006057503|00006057552|00006057556|00006057561|00006057562|00006057582|00006057701|00006057702|00006057703|00006057752|00006057756|00006057761|00006057762|00006057782|00006536903|00006536906|00006536907|00006537003|00006537006|00006537007|00006537303|00006537306|00006537307|00006537308|00006537309|00006537403|00006537406|00006537407|00006537408|00006537409|00007316318|00007316418|00007316618|00007316620|00007316718|00007316720|00007316818|00007316820|00087606005|00087606010|00087606313|00087606314|00087606413|00087607005|00087607010|00087607111|00087607112|00087607211|00087607311|00087607411|00087607731|00087607831|00087608131|00093104801|00093104805|00093104810|00093104819|00093104893|00093104898|00093104901|00093104905|00093104910|00093104919|00093104993|00093104998|00093504906|00093504986|00093505006|00093505086|00093571001|00093571005|00093571083|00093571093|00093571101|00093571105|00093571119|00093571193|00093571201|00093571205|00093571219|00093571293|00093721201|00093721401|00093721405|00093721410|00093721498|00093726001|00093726101|00093726105|00093726201|00093726205|00093726701|00093726710|00093726793|00093745501|00093745601|00093745701|00093767706|00093767786|00093767806|00093767886|00115164801|00115164901|00115164902|00115165001|00115165002|00169009201|00169009301|00172433010|00172433060|00172433070|00172433080|00172433110|00172433160|00172433170|00172433180|00172433188|00172443210|00172443260|00172443270|00172443280|00172443510|00172443560|00172443570|00172571010|00172571060|00172571070|00172571084|00172571110|00172571160|00172571170|00172571188|00172571210|00172571260|00172571270|00172571288|00173083718|00173083818|00173083918|00173084018|00185021301|00185021305|00185021501|00185021505|00185022101|00185022105|00185441601|00185441605|00228265711|00228265750|00228271511|00228271550|00228271811|00228271850|00228272811|00228274011|00228275111|00228275150|00228275211|00228275250|00228275311|00228275350|00310612560|00310613530|00310614530|00310622560|00310625030|00310626030|00310626060|00310627030|00310628030|00378023401|00378023405|00378024001|00378024401|00378035001|00378035201|00378035205|00378155091|00378157591|00378313101|00378313201|00378313301|00378600191|00378600291|00378718505|00378718605|00378718705|00403533574|00406202801|00406202805|00406202810|00406202901|00406202905|00406202910|00406203001|00406203005|00406203010|00555010702|00555038502|00555038504|00555038602|00555038702|00555062502|00555062602|00555062702|00591241101|00591241219|00591245501|00591245505|00591271301|00591271305|00591271960|00591272060|00591277501|00591277525|00591397101|00591397201|00591397301|00597014618|00597014660|00597014718|00597014760|00597014818|00597014860|00597015918|00597015960|00597015966|00597016818|00597016860|00597016866|00597017518|00597017560|00597017566|00597018018|00597018060|00597018066|00597027073|00597027094|00597027533|00597027581|00597028073|00597028090|00597029059|00597029074|00597029578|00597029588|00597030045|00597030093|00597038013|00597038068|00597038577|00597038586|00597039013|00597039071|00597039523|00597039582|00603446721|00603446728|00603446732|00603446821|00603446828|00603446832|00603446921|00603446928|00603446932|00615458053|00615458063|00781505001|00781505005|00781505010|00781505061|00781505101|00781505105|00781505161|00781505201|00781505205|00781505261|00781505501|00781517001|00781517101|00781517105|00781517201|00781517205|00781530401|00781530501|00781530601|00781550301|00781562660|00781562760|00904560118|00904560152|00904560154|00904560161|00904560180|00904560189|00904560193|00904560240|00904560253|00904560261|00904560289|00904560293|00904560340|00904560352|00904560361|00904560389|00904560393|00904563461|00904563561|00904563661|00904579461|00904579561|00904584914|00904584918|00904584940|00904584952|00904584953|00904584954|00904584980|00904584989|00904584993|00904585040|00904585052|00904585053|00904585089|00904585093|00904585140|00904585152|00904585189|00904585193|00904609061|00904609161|00904609261|00904610740|00904610761|00904610860|00904610861|00904632661|00904632761|00904632861|00904634314|00904634318|00904634325|00904634340|00904634352|00904634353|00904634354|00904634360|00904634380|00904634389|00904634393|00904634440|00904634452|00904634453|00904634489|00904634493|00904634540|00904634552|00904634589|00904634593|00904668961|00904669061|00904669161|00904716261|00904716361|00904716461|10135061710|10135061805|10135061905|10544005830|10544024802|10544024830|10544024860|10544024890|10544025330|10544025430|10544025530|10544052130|10544057930|10544057990|10544058960|10544063030|10544063090|10544094430|10544094490|10544094790|10631001917|10631020601|10631020602|10631023801|10631023802|12280000360|12280000460|12280002600|12280002700|13411016302|13411016303|13411016306|13411016309|13411016310|13411016402|13411016403|13411016406|13411016409|13411016410|13668028033|13668028060|13668028133|13668028160|13913000213|13913000316|15338040060|16590031330|16590031372|16590031382|16590039730|16590039760|16590039790|16714093801|16714093901|17236013201|17236013205|17236013301|17236013305|17236013401|20091053101|20091053105|20091053110|20091053301|20091053305|20091053310|20091053501|20091053505|20091053510|21695047100|21695047130|21695047160|21695047172|21695047178|21695047190|21695047230|21695047260|21695047300|21695047330|21695047360|21695047378|21695047390|21695056830|21695056860|21695082830|21695082860|21695082890|21695089400|23155010201|23155010205|23155010206|23155010209|23155010210|23155010301|23155010305|23155010306|23155010309|23155010310|23155010401|23155010405|23155010406|23155010409|23155010410|23155011501|23155011601|23155011701|23155023301|23155023305|23155023401|23155023405|23155023501|23155023505|23490090003|23490090006|23490683801|23490683802|23490683803|23490683804|23490683901|23490683902|23490726001|23490726002|23490726003|23490726004|23490744901|23490745806|24658029005|24658029012|24658029018|24658029027|24658029036|24658029046|24658029060|24658029090|24658029205|24658029218|24658029260|24658029290|24658079001|24979014604|24979015304|27241018860|27241018960|27241024001|27241024190|29033001801|29033001805|29033001810|29033002101|29033003106|29033003206|29033005501|29033005601|29300038901|29300038905|29300039901|33261014500|33261014502|33261014514|33261014530|33261014560|33261014590|33261014599|33261015700|33261015702|33261015714|33261015730|33261015760|33261015790|33261015799|33261037202|33261037230|33261037260|33261037290|33261041100|33261041130|33261041160|33261041190|33261041199|33261054000|33261054030|33261054060|33261054090|33261082130|33261082160|33261082190|33261082199|33342017609|33342017657|33342017709|33342017757|33342023911|33342024011|33358023400|33358023430|33358023460|33358023560|33358023630|33358023660|33358023730|33358023760|35356013060|35356013660|35356069160|35356079230|35356088618|35356088630|35356088660|35356088690|35356089730|35356089760|35356089790|35356092260|35356092290|35356093230|35356093260|35356093290|35356095930|35356095960|35356095990|35356097030|35356097060|35356097090|38779212604|38779212605|38779212608|38779212609|42254007130|42291030501|42291030601|42291049701|42291049710|42291049718|42291049736|42291049790|42291049801|42291049818|42291049850|42291051260|42291051360|42291055890|42291055990|42291058260|42291058360|42291059218|42291059260|42291059318|42291059360|42291060510|42291060512|42291060518|42291060527|42291060536|42291060545|42291060560|42291060590|42291060610|42291060618|42291060627|42291060690|42291060710|42291060718|42291060760|42291060790|42291061001|42291061010|42291061018|42291061036|42291061090|42291061101|42291061118|42291061127|42291061150|42291061190|42291061210|42291061212|42291061218|42291061227|42291061236|42291061245|42291061260|42291061290|42291061310|42291061318|42291061327|42291061390|42291061410|42291061418|42291061460|42291061490|42291069360|42291069460|42385090210|42385090410|42385094701|42385094705|42385094711|42385094801|42385094805|42385094811|42385094901|42385094905|42385094911|42571036007|42571036010|42806021305|42806021310|42806021501|42806021505|42806022105|42806031305|42806031401|42806031505|42806040560|42806040660|42806063201|42806063205|42806063301|43063001201|43063001260|43063001286|43063001290|43063001293|43063001294|43063037230|43063037260|43063039786|43063042830|43063042860|43063042890|43063042893|43063042894|43063042898|43063042993|43063042994|43063043030|43063043060|43063043090|43063043093|43063043094|43063043098|43063050730|43063050760|43063050790|43063052714|43063052720|43063052730|43063052760|43063052790|43063052793|43063052794|43063052798|43063053986|43063053990|43063053993|43063053994|43063054430|43063054460|43063054490|43063054493|43063054498|43063054590|43063054593|43063054594|43063054630|43063054660|43063054690|43063054693|43063054694|43063054698|43063088921|43063088930|43063088960|43063088990|43063088993|43063088998|43063089820|43063089830|43063089860|43063089890|43063089893|43063089898|43063090230|43063090260|43547024810|43547024811|43547024850|43547024910|43547024911|43547024950|43547025010|43547025011|43547025050|43547032010|43547032011|43547032050|43547032110|43547032150|43547032210|43547032250|43547035710|43547035711|43547035750|43547035810|43547035850|43547035910|43547035950|45802016972|45802021172|45865051730|45865051751|45865051760|45865051790|45963075302|47335030588|47335030688|49452454501|49452454502|49452454503|49452454504|49452454505|49483062001|49483062010|49483062050|49483062081|49483062101|49483062110|49483062150|49483062181|49483062201|49483062210|49483062250|49483062281|49483062301|49483062309|49483062310|49483062350|49483062401|49483062450|49884073601|49884073605|49884073701|49884073705|49884073801|49884073805|49884073901|49884073905|49884074001|49884074005|49884074101|49884074105|49884092101|49884092105|49884096701|49884096705|49884096801|49884096805|49884096901|49884096905|49999010600|49999010601|49999010628|49999010630|49999010660|49999010690|49999011600|49999011630|49999011660|49999011690|49999040130|49999040160|49999040190|49999049530|49999049560|49999066030|49999066060|49999082030|49999082060|49999082090|50090076900|50090076904|50090076905|50090077500|50090077502|50090077503|50090077505|50090088700|50090088702|50090088800|50090088801|50090088802|50090088803|50090088804|50090108000|50090108200|50090149400|50090149401|50090149402|50090149403|50090155000|50090203000|50090203001|50090203002|50090203003|50090203004|50090203100|50090203102|50090241000|50090241003|50090249200|50090255600|50090261200|50090261202|50090263500|50090263502|50090263503|50090263504|50090263505|50090276700|50090276701|50090279600|50090305000|50090305002|50090305004|50090305005|50090306400|50090306403|50090306404|50090306405|50090306406|50090308800|50090354300|50090357900|50090357902|50090357903|50090357904|50090357905|50090369102|50090371900|50090371901|50090371902|50090488400|50090489100|50090489200|50090494300|50090497300|50090524600|50090524601|50090539600|50090539601|50090539602|50090539603|50090621700|50090621800|50090623100|50090624400|50228010501|50228010505|50228010510|50228010530|50228010601|50228010605|50228010630|50228010701|50228010705|50228010710|50228010730|50228044501|50228044690|50228050360|50228050460|50268035611|50268035615|50268035711|50268035715|50268053111|50268053115|50268053211|50268053213|50268055011|50268055015|50268055111|50268055115|50458054060|50458054160|50458054260|50458054360|50458094001|50458094101|50458094201|50458094301|50742015401|50742015405|50742015410|50742015490|50742015501|50742015505|50742015510|50742015590|50742015601|50742015605|50742015610|50742015690|50742063360|50742063460|51079017201|51079017220|51079017301|51079017308|51079017401|51079017420|51079062601|51079062620|51079062720|51079097201|51079097217|51079097219|51079097220|51079097230|51079097256|51079097257|51079097301|51079097320|51079099501|51079099520|51224000750|51224000760|51224002050|51224002060|51224002070|51224010750|51224010760|51224012050|51224012060|51224012070|51224022050|51224022060|51224022070|51407005860|51407005960|51552150803|51552150804|51552150806|51655004524|51655024524|51655024525|51655029124|51655040424|51655040425|51655055025|51655055082|51655055182|51655056025|51655056125|51655056126|51655056152|51655056252|51655056325|51655056326|51927310500|51927440000|51991080505|51991080510|51991080601|51991080605|51991080705|51991080710|52372069801|52372069802|52372069803|52372069804|52817082005|52817082050|52817082150|52817082185|52959020700|52959020728|52959020730|52959020760|52959086002|52959086030|52959086060|52959086090|52959089601|52959089660|52959089690|53489046701|53489046705|53489046710|53489046801|53489046805|53489046810|53489046901|53489046905|53489046910|53746017801|53746017805|53746017810|53746017890|53746017901|53746017905|53746021801|53746021805|53746021810|53746021901|53746021905|53746021910|53746022001|53746022005|53746022010|54569420200|54569420202|54569420203|54569474000|54569474001|54569478600|54569478601|54569521000|54569521001|54569521100|54569521101|54569525200|54569525201|54569525202|54569535300|54569535302|54569535303|54569535304|54569535305|54569535306|54569536000|54569536003|54569536004|54569536005|54569536006|54569537300|54569537302|54569537303|54569537304|54569537305|54569554600|54569554601|54569554602|54569554603|54569560300|54569561800|54569561801|54569561802|54569561803|54569561900|54569561901|54569561902|54569561903|54569561904|54569599100|54569599200|54569599201|54569599300|54569599301|54569652300|54569652301|54569904300|54868079500|54868083000|54868083001|54868109700|54868109701|54868289400|54868354500|54868354501|54868354502|54868354503|54868354600|54868354601|54868416000|54868416001|54868452900|54868452901|54868452902|54868452903|54868456100|54868456101|54868456102|54868456103|54868456104|54868456400|54868456401|54868456402|54868456403|54868456404|54868456405|54868456600|54868456601|54868456602|54868456603|54868456604|54868456900|54868456901|54868456902|54868460900|54868460901|54868490600|54868496500|54868496501|54868496502|54868514800|54868514801|54868514802|54868514803|54868514804|54868515700|54868515701|54868518500|54868518501|54868518502|54868518503|54868518800|54868518801|54868518802|54868521700|54868521701|54868521702|54868521703|54868521704|54868521705|54868524300|54868524301|54868524302|54868524303|54868524304|54868526200|54868526201|54868528800|54868528801|54868528802|54868537600|54868537900|54868539900|54868539901|54868546700|54868546701|54868546702|54868550000|54868550001|54868550002|54868550500|54868550501|54868550502|54868555300|54868555301|54868555302|54868555800|54868555801|54868597300|55045250401|55045290400|55045290402|55045290406|55045290408|55045290409|55045290500|55045290506|55045290508|55045290600|55045290601|55045290602|55045290606|55045290608|55045290609|55045304501|55045304506|55045304508|55045376108|55048024630|55048024730|55048043460|55048043760|55048050830|55048050860|55048050930|55048050960|55048050971|55048050974|55048050990|55048051030|55048051060|55048051071|55048051074|55048051090|55048061160|55048061174|55048061230|55111069501|55111069601|55111069610|55111069701|55111069710|55154467500|55154588000|55154629600|55154789600|55289021160|55289028130|55289028160|55289028186|55289028190|55289038430|55289038460|55289038486|55289038490|55289038493|55289038494|55289061514|55289061530|55289061560|55289061586|55289061590|55289061593|55289061594|55289061598|55289091930|55289091960|55289091990|55289091993|55289091994|55289091998|55289093430|55289093460|55289093493|55289093494|55289093498|55700004130|55700024830|55700024860|55700024890|55700032060|55700032090|55700039530|55700039560|55700039590|55700046930|55700046960|55700046990|55700047560|55700061290|55700061830|55700061860|55700061890|55700066630|55700066660|55700066690|55700066930|55700066960|55700066990|55700073090|55700073460|55700073490|55700073630|55700073660|55700073690|55700092490|55887017330|55887036830|55887036860|55887036890|55887041430|55887041460|55887041490|55887057130|55887057160|55887057182|55887057190|55887061430|55887061490|55887062730|55887062760|55887062782|55887062790|55887062792|55887094030|55887094060|55887094090|57237002301|57237002305|57237002401|57237002405|57237002501|57237002505|57237021760|57237021781|57237021860|57237021881|57664039713|57664039718|57664039751|57664039753|57664039758|57664039788|57664043513|57664043518|57664043551|57664043553|57664043558|57664043588|57664047413|57664047418|57664047451|57664047453|57664047458|57664047488|57664072488|57664072588|57664072788|57866799101|57866905401|57866905402|57866905403|57866905404|57866905501|57866905502|57866905503|57866905504|57866905601|57866905602|57866905603|57866905604|57866905605|57866905701|57866905702|57866905901|57866905902|58016005800|58016005830|58016005860|58016005890|58016021300|58016021310|58016021330|58016021360|58016041100|58016041102|58016041130|58016041160|58016041190|58016045700|58016045710|58016045730|58016045760|58016046600|58016046630|58016046660|58016046690|58016053600|58016053630|58016053660|58016053690|58016055300|58016055310|58016055330|58016055360|58016077200|58016077230|58016077260|58016077290|58016088300|58016088330|58016088360|58016088390|58657064001|58657064010|58657064050|58657064101|58657064110|58657064150|58657064201|58657064210|58657064250|58864001528|58864001530|58864001560|58864001590|58864050730|58864069330|58864069360|58864071130|58864078930|58864078960|58864085130|58864095230|58864095330|59630057460|59630057560|59762233007|59762233106|59762233108|59762233206|59762233208|59762432000|59762432002|59762432006|59762432100|59762432102|59762432106|59762432200|59762432202|59762432206|60429011101|60429011110|60429011112|60429011118|60429011127|60429011136|60429011145|60429011160|60429011190|60429011201|60429011205|60429011218|60429011227|60429011260|60429011290|60429011301|60429011305|60429011310|60429011318|60429011360|60429011390|60429028001|60429028010|60429028018|60429072218|60429072312|60429072318|60429072505|60429072518|60429072560|60429072590|60505019000|60505019001|60505019004|60505019008|60505019100|60505019101|60505019104|60505019108|60505019200|60505019201|60505019204|60505019208|60505026001|60505026002|60505026007|60505132901|60687014301|60687014311|60687015501|60687015511|60687016201|60687016211|60687064001|60687064011|60760004260|60760010090|60760017530|60760017590|60760017630|60760017690|60760049760|60760049790|60760052360|60760062360|60760097330|60760097360|60760097390|60760097398|60760097460|60760097490|60760097560|60760097590|61442036101|61442036105|61442036110|61442036201|61442036205|61442036301|61442036305|61919031330|61919031360|61919031380|61919031390|61919039730|61919039760|61919039782|61919039790|61919041860|61919045030|61919045060|61919045090|61919076960|61919099060|61919099082|61919099090|61919099260|62022057460|62022057560|62037057101|62037057110|62037057701|62037057710|62037067401|62037067405|62037067410|62037067501|62037067505|62037067510|62037067601|62037067605|62037067610|62135068005|62135068018|62135068090|62135068318|62135068330|62135068390|62135068405|62135068418|62135068490|62584018208|62584025901|62584025911|62584025985|62584033201|62584033211|62584045201|62584045285|62682500501|62756014201|62756014202|62756014301|62991304901|62991304902|62991304903|63187077930|63187077990|63304020601|63304020602|63304076701|63304086001|63304086005|63304086030|63629139201|63629139202|63629139203|63629139501|63629139502|63629139503|63629139601|63629139602|63629139701|63629139702|63629139703|63629139704|63629139705|63629139706|63629139707|63629250101|63629250201|63629279301|63629279302|63629279303|63629279304|63629288301|63629288302|63629288303|63629288306|63629399801|63629850101|63629850201|63629850301|63629850401|63629914601|63629914701|63739029910|63739030010|63739030110|63739064010|63739070210|63874050101|63874050104|63874050110|63874050114|63874050120|63874050124|63874050128|63874050130|63874050160|63874050190|63874063501|63874063510|63874063520|63874063528|63874063530|63874063560|63874063590|63874093901|63874093910|63874093930|63874093960|63874097401|63874097430|63874097460|64679052804|64679052805|64679052904|64679052905|64679053004|64679053005|64764015518|64764015560|64764015818|64764015860|64764031030|64764033560|64764033760|64764051030|65162017410|65162017411|65162017450|65162017510|65162017511|65162017550|65162017710|65162017711|65162017750|65162017809|65162017810|65162017811|65162017850|65162017910|65162021810|65162021811|65162021850|65162021910|65162021911|65162021950|65162022010|65162022011|65162022050|65862000801|65862000805|65862000890|65862000899|65862000901|65862000905|65862000990|65862001001|65862001005|65862001046|65862001090|65862001099|65862008001|65862008005|65862008101|65862008105|65862008201|65862008205|65862029101|65862029105|65862029201|65862052518|65862052560|65862052618|65862052660|66116023330|66116028260|66267049314|66267049330|66267049360|66267049390|66267049391|66267049392|66267049393|66267049730|66267049760|66267055330|66336022260|66336027030|66336027060|66336027090|66336027094|66336029260|66336031930|66336035830|66336035860|66336035862|66336035890|66336050030|66336050090|66336078430|66336078460|66336078490|66336085030|66336085060|66336085090|66336088330|66336088360|66336088390|66336088414|66336088428|66336088430|66336088460|66336088462|66336088490|66336089030|66689031816|67046046030|67877015901|67877015905|67877015910|67877021701|67877021705|67877021710|67877021801|67877021805|67877021810|67877022101|67877022105|67877022110|67877041301|67877041305|67877041390|67877041401|67877056101|67877056105|67877056110|67877056201|67877056205|67877056210|67877056301|67877056305|67877056310|68012000213|68012000316|68012000450|68071002830|68084007201|68084007211|68084013601|68084013701|68084013801|68084074525|68084074595|68084081932|68084081933|68115015830|68115015860|68115015930|68115015960|68115023030|68115023060|68115023100|68115023130|68115023160|68115023190|68115023230|68115023245|68115023260|68115089160|68180033607|68180033707|68180033801|68180033909|68180049001|68180049101|68382002705|68382002801|68382002805|68382002810|68382002901|68382002905|68382002910|68382003001|68382003005|68382003010|68382003905|68382018401|68382018501|68382018601|68382065301|68382065305|68382065401|68382065405|68382065501|68382065505|68382075801|68382075805|68382075810|68382075901|68382075905|68382075910|68382076001|68382076005|68382076010|68405001116|68405001916|68462015901|68462015905|68462015910|68462015990|68462016001|68462016005|68462016010|68462016101|68462016105|68462016110|68462016190|68462052001|68462052190|68645012059|68645029059|68645030059|68645053959|68645054459|68645054559|68645054659|68645054759|68645054859|68645054959|68645058259|68645058359|68645058459|68645059559|68682001710|68682001890|68682002150|68788043509|68788718001|68788718003|68788718006|68788718009|68788733701|68788733703|68788733706|68788733708|68788733709|68788780301|68788780303|68788780306|68788780308|68788780309|68788786701|68788786703|68788786706|68788786707|68788786708|68788786709|68788788901|68788788903|68788788906|68788788907|68788788908|68788788909|68788790101|68788790103|68788790106|68788790108|68788790109|68788808301|68788808303|68788808306|68788808308|68788808309|68788811001|68788811003|68788811006|68788811007|68788811008|68788811009|68788822501|68788912206|68788996601|68788996603|68788996606|68788996608|68788996609|68981003301|69367018001|69367018005|69367018010|69367018101|69367018105|69367018201|69367018205|69367018210|70010006301|70010006305|70010006309|70010006310|70010006401|70010006405|70010006409|70010006410|70010006501|70010006505|70010006509|70010006510|70010049101|70010049105|70010049110|70010049201|70010049205|70010049210|70010049709|70882010556|70882012456|70882012530|70914000601|70934008330|70934008390|70934011730|70934013430|70934013498|70934013530|70934013560|70934013630|70934013660|70934020730|70934020760|70934021230|70934021260|70934021290|70934040430|70934040460|70934040490|70934042290|70934042730|70934042760|70934042790|70934078460|70934078830|70934078860|70934078890|70934083090|71093013204|71093013205|71093013206|71093013304|71093013305|71093013404|71093013405|71205014230|71205014260|71205018630|71205018660|71205018690|71205027030|71205027090|71205037230|71205054800|71205054830|71205055560|71205055578|71205055590|71205056260|71205056290|71205056760|71205062230|71205068630|71205068660|71205068672|71205068690|71205085900|71205085930|71205085955|71205085960|71205085964|71205085972|71205085978|71205085990|71205086000|71205086030|71205086055|71205086060|71205086064|71205086072|71205086078|71205086090|71205088200|71205088211|71205088230|71205088255|71205088260|71205088264|71205088272|71205088278|71205088290|71205088300|71205088311|71205088330|71205088355|71205088360|71205088364|71205088372|71205088378|71205088390|71205088400|71205088411|71205088430|71205088455|71205088460|71205088464|71205088472|71205088478|71205088490|71335008501|71335008502|71335008503|71335008504|71335008505|71335008506|71335008507|71335008508|71335025001|71335025002|71335025003|71335025004|71335025005|71335025006|71335029301|71335029302|71335029303|71335029304|71335029305|71335029306|71335029307|71335029308|71335072004|71335077602|71335077603|71335128901|71335128902|71335128903|71335128905|71335128906|71335128908|71709011006|71709011007|71709011106|71709011107|71709011206|71709011207|71717010411|71717010510|71717010550|71717010611|71800000801|72189006490|72189015030|72189015090|72189021990|72189022030|72189022060|72189022082|72189022090|72189022190|72336006430|72578003601|72789000930|72789000960|72789000990|72789000993|72789005930|72789005960|72789005990|72789005993|72789005998|72789009730|72789009760|72789010501|72789010582|72789010590|72789010593|72789010595|72789010601|72789010682|72789010690|72789010693|72789018921|72789018930|72789018960|72789018990|72789018993|72789018998|72789019220|72789019221|72789019230|72789019260|72789019290|72789019293|72789027501|75834050001|75834050005|76385012810|76385012901|76385012950|76519115203|76519119206)"

# DPP4 inhibitors use
DPP4_drugs_regex <- "(00003421411|00003421421|00003421511|00003421521|00003421531|00003421541|00003422111|00003422216|00003422311|00006007814|00006007828|00006007861|00006007862|00006007882|00006008014|00006008028|00006008061|00006008062|00006008082|00006008107|00006008114|00006008131|00006008154|00006008182|00006011201|00006011228|00006011231|00006011254|00006022101|00006022128|00006022131|00006022154|00006027701|00006027702|00006027714|00006027727|00006027728|00006027730|00006027731|00006027733|00006027754|00006027782|00006053331|00006053354|00006053531|00006053554|00006053731|00006053754|00006057501|00006057502|00006057503|00006057552|00006057556|00006057561|00006057562|00006057582|00006057701|00006057702|00006057703|00006057752|00006057756|00006057761|00006057762|00006057782|00006075331|00006075354|00006075382|00006075731|00006075754|00006075782|00006077331|00006077354|00006077382|00006536703|00006536706|00006536707|00006536708|00006536709|00006536803|00006536806|00006536807|00006536808|00006536809|00310610030|00310610090|00310610530|00310610550|00310610590|00310612560|00310613530|00310614530|00310677030|00310678030|00597014030|00597014061|00597014090|00597014618|00597014660|00597014718|00597014760|00597014818|00597014860|00597016430|00597016439|00597016490|00597018230|00597018239|00597018290|00597027073|00597027094|00597027533|00597027581|00597038013|00597038068|00597038577|00597038586|00597039013|00597039071|00597039523|00597039582|12280040130|35356010330|35356013660|45802008765|45802010365|45802015065|45802016972|45802021172|45802023865|45802026065|45802030465|45802035165|45802040265|45802049965|50090103600|50090103602|50090347201|50090408400|50090408600|50090408700|50090438300|50090551701|50090624400|54569592500|54868109700|54868109701|54868584000|54868584001|54868597300|54868603100|54868603101|54868630900|55048043460|55048043760|55154041008|55154504008|55154504208|55154693102|64764012103|64764012303|64764012403|64764012530|64764025030|64764025103|64764025303|64764025403|64764033560|64764033760|64764062530|66105065203|68258599003|68258599009)"

# pioglitazone use (exclusion criteria)
pioglitazone_drugs_regex <- "(00093204605|00093204656|00093204698|00093204705|00093204756|00093204798|00093204805|00093204856|00093204898|00093727105|00093727156|00093727198|00093727205|00093727256|00093727298|00093727305|00093727356|00093727398|00378004805|00378004877|00378004893|00378022805|00378022877|00378022893|00378031805|00378031877|00378031893|00591320505|00591320519|00591320530|00591320605|00591320619|00591320630|00591320705|00591320719|00591320730|00781542010|00781542031|00781542092|00781542110|00781542131|00781542192|00781542210|00781542231|00781542292|00904709061|00904709661|12280006015|12280006030|13411010101|13411010103|13411010105|13411010106|13411010109|13411010201|13411010203|13411010206|13411010209|13411010215|13411010301|13411010303|13411010306|13411010309|13411010315|13668011905|13668011930|13668011990|13668012005|13668012030|13668012090|13668014005|13668014030|13668014090|16729002010|16729002015|16729002016|16729002110|16729002115|16729002116|16729002210|16729002215|16729002216|21695014715|21695014815|33342005407|33342005410|33342005415|33342005507|33342005510|33342005515|33342005607|33342005610|33342005615|43063089430|43063089490|43063089530|43063089590|43063089690|43547042603|43547042609|43547042650|43547042703|43547042709|43547042750|43547042803|43547042809|43547042850|49999044915|49999044930|49999045030|49999045130|49999045190|50090131900|50090131901|50090132000|50090132001|50090132100|50090132101|50090239001|50090240100|50090240101|50090455600|50090455601|50090458600|50090458601|50090460500|50090460501|50090478001|51079051301|51079051320|51079051401|51079051420|51079051520|51991070810|51991070833|51991070890|51991070910|51991070933|51991070990|51991071010|51991071033|51991071090|52343005305|52343005330|52343005390|52343005405|52343005430|52343005490|52343005505|52343005530|52343005590|53217009530|53217009590|54458086410|54458086510|54458086610|54458088310|54458088410|54458088510|54569488000|54569488100|54569488200|54569635400|54569635401|54569635500|54569635501|54569635600|54569635601|54868434300|54868434301|54868435400|54868435401|54868439100|54868439101|55289054030|55289086215|55289086230|55887097530|57237021905|57237021930|57237021990|57237022005|57237022030|57237022090|57237022105|57237022130|57237022190|58864067014|58864067030|58864074515|58864074530|60429033010|60429033030|60429033090|60429033110|60429033130|60429033190|60429033210|60429033230|60429033290|60687039101|60687039111|61919078130|61919078190|63187074690|63304025405|63304025430|63304025490|63304025505|63304025530|63304025590|63304026105|63304026130|63304026190|63304031105|63304031130|63304031190|63304031205|63304031230|63304031290|63304031305|63304031330|63304031390|64764015104|64764015105|64764015106|64764030114|64764030115|64764030116|64764045124|64764045125|64764045126|65862051205|65862051230|65862051290|65862051305|65862051330|65862051405|65862051430|66105015401|66105015403|66105015406|66105015409|66105015415|66105015601|66105015603|66105015606|66105015609|66105015615|66105073201|66105073203|66105073206|66105073209|66105073215|66336036030|66336036130|66336061330|66336085730|66336085790|66336085830|66336085890|66336085930|66336085990|68071040515|68071040615|68071040715|68084062901|68084063001|68084063101|68084064901|68084065201|68084066001|68084087801|68084087811|68115067115|68115067120|68115067130|68115067190|68115084130|68258303403|68258595103|68258595203|68258595303|68258599103|68788751401|68788751403|68788751406|68788751409|68788770101|68788770103|68788770106|68788770109|68788798901|68788798903|68788798906|68788798909|71335133301|72189010590|72189029290|72189029390|72606050101|72606050102|72606050103|72606050201|72606050202|72606050203|72606050301|72606050302|72606050303|72606057001|72606057002|72606057003|72606057101|72606057102|72606057103|72606057201|72606057202|72606057203)"

# Create a pattern to detect SGLT2 inhibitors or GLP1RAs or their combinations to apply as exclusion criteria in the lookback period
SGLT2_GLP1RAs_drugs_including_combinations <- "(00002143301|00002143361|00002143380|00002143401|00002143461|00002143480|00002223601|00002223680|00002318201|00002318280|00003142711|00003142811|00006536303|00006536306|00006536307|00006536308|00006536309|00006536310|00006536403|00006536406|00006536407|00006536408|00006536409|00006536703|00006536706|00006536707|00006536708|00006536709|00006536803|00006536806|00006536807|00006536808|00006536809|00006536903|00006536906|00006536907|00006537003|00006537006|00006537007|00006537303|00006537306|00006537307|00006537308|00006537309|00006537403|00006537406|00006537407|00006537408|00006537409|00024574502|00024574702|00024576105|00024576302|00169280015|00169291115|00169406012|00169406013|00169406090|00169406099|00169413001|00169413013|00169413211|00169413212|00169413602|00169418113|00169430313|00169430330|00169430713|00169430730|00169431413|00169431430|00169450114|00169450514|00169451714|00169452414|00169452514|00169477212|00169477297|00173086601|00173086602|00173086635|00173086701|00173086735|00310620530|00310621030|00310621039|00310622560|00310625030|00310626030|00310626060|00310627030|00310628030|00310651201|00310652004|00310652401|00310653001|00310653004|00310654001|00310654004|00310677030|00310678030|00597015230|00597015237|00597015290|00597015330|00597015337|00597015390|00597015918|00597015960|00597015966|00597016430|00597016439|00597016490|00597016818|00597016860|00597016866|00597017518|00597017560|00597017566|00597018018|00597018060|00597018066|00597018230|00597018239|00597018290|00597028073|00597028090|00597029059|00597029074|00597029578|00597029588|00597030045|00597030093|00597038013|00597038068|00597038577|00597038586|00597039013|00597039071|00597039523|00597039582|50090285300|50090348100|50090348200|50090348300|50090348400|50090425700|50090436400|50090438400|50090449200|50090450300|50090502900|50090503300|50090503301|50090503400|50090503401|50090546700|50090594900|50090605100|50090618200|50090618300|50090621700|50090621800|50090623100|50458014030|50458014090|50458014130|50458014190|50458054060|50458054160|50458054260|50458054360|50458094001|50458094101|50458094201|50458094301|54569650700|54868538400|54868538401|55154041108|55154041208|55154142508|55154142608|55154693208|55154693308|66780021007|66780021008|66780021201|66780021904|66780022601|68258894701|68258894802)"
```


```{r}
#|label: Others
# Nursing home admissions (exclusion criteria)
nursing_home_codes <- "^(35|54|55|56)"
```

# Cohort building

## Inclusion and exclusion criteria

I will identify new users of SGLT2 inhibitors and GLP1RAs. I will exclude patients using both or using these medications combined with other antidiabetic medications. The earliest use of either SGLT2s or GLP1RAs must be Jan 1, 2018. The index date is the first prescription of SLGT2s or GLP1RAs. In the lookback period, patients who had a history of use of either medication classes will be excluded. The lookback period is 1 year prior to the first use of SGLT2i or GLP1RAs. All patients should have at least 1 year of continuous enrollment before the index date. Patients with bladder cancer in the look-back period were excluded.

Next steps: start building the cohort

# Cohort building

Note: I will ignore claims reversals and claims with zero days supply for simplicity.

## Identify users of SGLT2i and GLP1RAs

```{r}
#| label: users of sglt2i and glp1ra
# This definition excludes combinations
sglt2i_glp1ra_users <- ccaed |> 
  filter(YEAR %in% 2018:2019) |> 
  select(ENROLID, NDCNUM, SVCDATE) |> 
  filter(!is.na(ENROLID)) |> 
  filter(
    NDCNUM %in% c(GLP1RAs_drugs$NDCNUM, SGLT2_drugs$NDCNUM)
  ) |> 
  collect() |> 
  filter(SVCDATE == min(SVCDATE), .by = ENROLID) |> 
  mutate(exposure = ifelse(NDCNUM %in% GLP1RAs_drugs$NDCNUM, "GLP1RAs", "SGLT2i")) |> 
  fastDummies::dummy_cols(select_columns = "exposure", remove_selected_columns = T) |> 
  select(-NDCNUM) |> 
  mutate(
    across(starts_with("exposure_"), ~max(.x)), .by = ENROLID
  ) |> 
  arrange(ENROLID) |> 
  distinct() |> 
  filter(!(exposure_GLP1RAs == 1 & exposure_SGLT2i == 1)) |> 
  # remove exposure_GLP1RAs since exposure_SGLT2i is sufficient to define the exposure variable where 1 = SGLT2i and 0 = GLP1RAs
  select(-exposure_GLP1RAs)

```

```{r}
#| label: continuous enrollment
enrollment_data <-  ccaet |>
    select(ENROLID, DTSTART, DTEND) |>
    filter(ENROLID %in% unique(sglt2i_glp1ra_users$ENROLID)) |>
    to_duckdb() |>
    arrange(ENROLID, DTSTART) |>
    group_by(ENROLID) |>
    mutate(gap_days = abs((lag(DTEND) - DTSTART)+1) ) |>
    mutate(continuous_cov_start = if_else(gap_days > 0 | is.na(gap_days), DTSTART, NA)) |>
    mutate(cont_enrol = ifelse(is.na(continuous_cov_start),0,1)) |>
    mutate(episode = cumsum(cont_enrol)) |>
    group_by(ENROLID, episode) |>
    summarise(start_cont_enrol = min(DTSTART),
              end_cont_enrol = max(DTEND)) |>
    collect()

sglt2i_glp1ra_users_cont_enrol <- sglt2i_glp1ra_users |>
    mutate(pre_cont_enrol_period_begin = SVCDATE - 365) |>
    mutate(post_cont_enrol_period_end = SVCDATE + 0) |>
    left_join(enrollment_data) |>
    arrange(ENROLID) |>
    filter(interval(pre_cont_enrol_period_begin, SVCDATE) %within% interval(start_cont_enrol, end_cont_enrol),
           interval(SVCDATE, post_cont_enrol_period_end) %within% interval(start_cont_enrol, end_cont_enrol)
    ) |>
    select(-c(pre_cont_enrol_period_begin, post_cont_enrol_period_end, episode, start_cont_enrol, end_cont_enrol))



sglt2i_glp1ra_users_cont_enrol <- sglt2i_glp1ra_users_cont_enrol |> 
  rename(index_date = SVCDATE)
```

```{r}
#| label: capture pre-index covariates
# Outpatient data
outpatient_comorbidities <- ccaeo |> 
    select(ENROLID, SVCDATE, contains("DX"), contains("PROC")) |> 
    right_join(sglt2i_glp1ra_users_cont_enrol, by = "ENROLID") |> 
    to_duckdb() |> 
    filter(between(SVCDATE - index_date, -365, 0)) |> # Covariate ascertainment period
    mutate(
        hypertension =           ifelse((if_any(contains("DX"), ~str_detect(.x, {{hypertension_regex}}))), 1, 0),
        hyperlipidemia =       ifelse((if_any(contains("DX"), ~str_detect(.x, {{hyperlipidemia_regex}}))), 1, 0),
        dialysis =          ifelse((if_any(contains("PROC"), ~str_detect(.x, {{dialysis_regex}}))), 1, 0),
        esrd =             ifelse((if_any(contains("DX"), ~str_detect(.x, {{esrd_regex}}))), 1, 0),
        liver_disease =                ifelse((if_any(contains("DX"), ~str_detect(.x, {{liver_disease_regex}}))), 1, 0),
        transplant =                 ifelse((if_any(contains("DX"), ~str_detect(.x, {{transplant_regex}}))), 1, 0),
        type2_diabetes =            ifelse((if_any(contains("DX"), ~str_detect(.x, {{type2_diabetes_regex}}))), 1, 0),
        bladder_cancer =      ifelse((if_any(contains("DX"), ~str_detect(.x, {{bladder_cancer_regex}}))), 1, 0),
        nursing_home =        ifelse((if_any(contains("STDPLAC"), ~str_detect(.x, {{nursing_home_regex}}))), 1, 0)
    ) |>
    mutate(
        across(hypertension:nursing_home, ~ifelse(is.na(.x), 0, .x)) 
    ) |> 
    # filter(if_any(achalasia:ibs, ~ .x == 1)) |> 
    select(-contains("DX"), -contains("PROC")) |>
    collect()

# Inpatient data
inpatient_comorbidities <- ccaei |> 
    select(ENROLID, ADMDATE, contains("DX"), contains("PROC")) |> 
    right_join(sglt2i_glp1ra_users_cont_enrol, by = "ENROLID") |> 
    to_duckdb() |> 
    filter(between(ADMDATE - index_date, -365, 0)) |> # Covariate ascertainment period
    mutate(
        hypertension =           ifelse((if_any(contains("DX"), ~str_detect(.x, {{hypertension_regex}}))), 1, 0),
        hyperlipidemia =       ifelse((if_any(contains("DX"), ~str_detect(.x, {{hyperlipidemia_regex}}))), 1, 0),
        dialysis =          ifelse((if_any(contains("PROC"), ~str_detect(.x, {{dialysis_regex}}))), 1, 0),
        esrd =             ifelse((if_any(contains("DX"), ~str_detect(.x, {{esrd_regex}}))), 1, 0),
        liver_disease =       ifelse((if_any(contains("DX"), ~str_detect(.x, {{liver_disease_regex}}))), 1, 0),
        transplant =        ifelse((if_any(contains("DX"), ~str_detect(.x, {{transplant_regex}}))), 1, 0),
        type2_diabetes =   ifelse((if_any(contains("DX"), ~str_detect(.x, {{type2_diabetes_regex}}))), 1, 0),
        bladder_cancer =      ifelse((if_any(contains("DX"), ~str_detect(.x, {{bladder_cancer_regex}}))), 1, 0)
    ) |>
    mutate(
        across(hypertension:bladder_cancer, ~ifelse(is.na(.x), 0, .x)) 
    ) |> 
    # filter(if_any(achalasia:ibs, ~ .x == 1)) |> 
    select(-contains("DX"), -contains("PROC")) |>
    collect()


# Pharmacy data
medications_comorbidities <- ccaed |> 
    select(ENROLID, SVCDATE, contains("NDCNUM")) |> 
    right_join(sglt2i_glp1ra_users_cont_enrol, by = "ENROLID") |> 
    to_duckdb() |> 
    filter(between(ADMDATE - index_date, -365, 0)) |> # Covariate ascertainment period
    mutate(
        metformin =       ifelse((if_any(contains("NDCNUM"), ~str_detect(.x, {{metformin_drugs_regex}}))), 1, 0),
        pioglitazone =   ifelse((if_any(contains("NDCNUM"), ~str_detect(.x, {{pioglitazone_drugs_regex}}))), 1, 0),
        past_user =           ifelse((if_any(contains("NDCNUM"), ~str_detect(.x, {{SGLT2_GLP1RAs_drugs_including_combinations_regex}}))), 1, 0),
        DPP4 =          ifelse((if_any(contains("NDCNUM"), ~str_detect(.x, {{DPP4_drugs_regex}}))), 1, 0)
    ) |>
    mutate(
        across(metformin:DPP4, ~ifelse(is.na(.x), 0, .x)) 
    ) |> 
    # filter(if_any(achalasia:ibs, ~ .x == 1)) |> 
    select(-contains("NDCNUM")) |>
    collect()


# Demographic data
demographics <-  ccaet |>
      select(ENROLID, DTEND, DTSTART, PLANTYP, AGE, AGEGRP, DOBYR, REGION, SEX) |>
      filter(ENROLID %in% sglt2i_glp1ra_users_cont_enrol$ENROLID) |>
      right_join(sglt2i_glp1ra_users_cont_enrol |> select(ENROLID, index_date)) |>
      filter(index_date >= DTSTART, index_date <= DTEND) |>
      select(-DTEND, -DTSTART) |>
      collect()


sglt2i_glp1ra_users_cont_enrol_combined <- 
  bind_rows(
    outpatient_comorbidities,
    inpatient_comorbidities) |> 
  full_join(medications_comorbidities) |> 
  full_join(demographics) |> 
    distinct() |> 
    group_by(ENROLID) |> 
    mutate(
        across(hypertension:last_col(), ~max(.x))
    ) |> 
  ungroup() |> 
  distinct() 
```

```{r}
#| label: apply inclusion exclusion criteria

# Apply the inclusion\exclusion criteria
sglt2i_glp1ra_users_cont_enrol_combined_clean <- 
  sglt2i_glp1ra_users_cont_enrol_combined |> 
  filter(AGE >= 40, type2_diabetes == 1, past_user == 0, bladder_cancer == 0, esrd == 0,
         transplant == 0, pioglitazone == 0, nursing_home == 0, dialysis == 0) |> 
  select(-c(type2_diabetes, past_user, bladder_cancer, esrd, transplant, pioglitazone, nursing_home, dialysis)) 

```

```{r}
#|label: Cpature outcome variables
# Outpatient data
outpatient_outcome <- ccaeo |> 
    select(ENROLID, SVCDATE, contains("DX")) |> 
    right_join(sglt2i_glp1ra_users_cont_enrol_combined_clean, by = "ENROLID") |> 
    to_duckdb() |> 
    filter(between(SVCDATE - index_date, 1, 730)) |> # Covariate ascertainment period
    mutate(
        bladder_cancer_outcome =      ifelse((if_any(contains("DX"), ~str_detect(.x, {{bladder_cancer_regex}}))), 1, 0)
    ) |>
    mutate(
        across(bladder_cancer_outcome, ~ifelse(is.na(.x), 0, .x)) 
    ) |> 
    # filter(if_any(achalasia:ibs, ~ .x == 1)) |> 
    select(-contains("DX"), -contains("PROC")) |>
    collect()

# Inpatient data
inpatient_outcome <- ccaei |> 
    select(ENROLID, ADMDATE, contains("DX")) |> 
    right_join(sglt2i_glp1ra_users_cont_enrol_combined_clean, by = "ENROLID") |> 
    to_duckdb() |> 
    filter(between(ADMDATE - index_date, 1, 730)) |> # Covariate ascertainment period
    mutate(
        bladder_cancer_outcome =      ifelse((if_any(contains("DX"), ~str_detect(.x, {{bladder_cancer_regex}}))), 1, 0)
    ) |>
    mutate(
        across(bladder_cancer_outcome, ~ifelse(is.na(.x), 0, .x)) 
    ) |> 
    # filter(if_any(achalasia:ibs, ~ .x == 1)) |> 
    select(-contains("DX")) |>
    collect()

# Merge the outcomes from inpatients and outpatient claims
sglt2i_glp1ra_users_cont_enrol_combined_clean_outcome <- bind_rows(outpatient_outcome, inpatient_outcome) |> 
  mutate(
    .by = ENROLID,
    bladder_cancer_outcome = max(bladder_cancer_outcome, na.rm = T)
  ) |> 
  distinct()

```

# Data analysis

## Descriptive statistics

```{r}
# Create analytic dataset
analytic_data <- sglt2i_glp1ra_users_cont_enrol_combined_clean_outcome |> 
  # select relevant variables
  select(-c(index_date, AGEGRP, DOBYR)) |> 
  rename(
    `Bladder cancer` = bladder_cancer_outcome,
    Hypertension = hypertension,
    Hyperlipidemia = hyperlipidemia,
    `Liver disease` = liver_disease,
    SGLT2i = exposure_SGLT2i,
    Metformin = metformin,
    `DPP4 inhibitors` = DPP4,
    `Plan type` = PLANTYP,
    Age = AGE,
    Region = REGION,
    Sex = SEX
  ) |> 
  mutate(SGLT2i = ifelse(SGLT2i == 1, "SGLT2i", "GLP1RAs")) |> 
  mutate(Sex = ifelse(Sex == 1, "Male", "Female"),
         `Plan type` = case_when(
          `Plan type` == 1 ~ "Basic/major medical",
          `Plan type` == 2 ~ "Comprehensive",
          `Plan type` == 3 ~ "EPO",
          `Plan type` == 4 ~ "HMO",
          `Plan type` == 5 ~ "POS",
          `Plan type` == 6 ~ "PPO",
          `Plan type` == 7 ~ "POS with capitation",
          `Plan type` == 8 ~ "CDHP",
          `Plan type` == 9 ~ "HDHP"
         ),
         
         Region = case_when(
           Region == 1 ~ "Northeast",
           Region == 2 ~ "North Central",
           Region == 3 ~ "South",
           Region == 4 ~ "West",
           Region == 5 ~ "Unknown"
         )
         
         )

# Create table 1
analytic_data |> 
  tbl_summary(by = SGLT2i,
              include = -c(ENROLID, `Bladder cancer`)) %>%
  add_difference(everything() ~ "smd") |> 
  bold_labels()
```

## ATE estimation using IPW

```{r}
W_object <- weightit(SGLT2i ~ Hypertension + Hyperlipidemia + Metformin + `DPP4 inhibitors` + Age + `Plan type` + Region + Sex,
                     data = analytic_data,
                     method = "glm", 
                     estimand = "ATE")
analytic_data$weights <- W_object$weights

analytic_data |> 
  rstatix::get_summary_stats(weights)

fit <- glm(`Bladder cancer` ~ SGLT2i + Hypertension + Hyperlipidemia + Metformin + `DPP4 inhibitors` + Age + 
                `Plan type` + Region + Sex,
           data = analytic_data, weights = weights,
           family = quasibinomial)

# Produce effect estimates with robust standard errors
marginaleffects::avg_comparisons(fit,
                variables = "SGLT2i",
                vcov = "HC3",
                wts = "weights",
                comparison = "lnratioavg",
                transform = "exp") |> 
  tibble()
```
